<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>FindIT - Lost & Found (Admin)</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles/dashboardstyle.css">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom py-3">
    <div class="container">
      
      <!-- Brand -->
      <a class="navbar-brand fw-bold" href="#">
        <img src="assets/fintitlogo.png" alt="Logo" style="height: 40px; width: auto; margin-right: 8px;">
      </a>

      <!-- Toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Navbar Links -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="admin_dashboard.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_User_Management.html">Users</a></li>
        </ul>

        <!-- Right Side -->
        <div class="d-flex align-items-center gap-2">
        <button class="btn btn-report-lost" id="editDeleteBtn">
  Edit Items
</button>
          <button class="btn btn-report-lost" onclick="window.location.href='AdminforReview.html'">
            For Review
          </button>

          <!-- Profile Dropdown -->
          <div class="dropdown ms-3">
            <img src="assets/adminpic.png" alt="Profile" class="rounded-circle" height="40" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">

            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li><a class="dropdown-item" href="profile.html">Profile</a></li>
              <li><a class="dropdown-item" href="settings.html">Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">Log Out</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="container mt-4"> 
    <!-- Header + Search -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Items List</h4>
      <div class="d-flex align-items-center">
        <img src="assets/searchbarimage.png" alt="Search" class="me-2">
        <input type="text" class="form-control form-control-sm" placeholder="Search Lost Items">
      </div>
    </div>

    <!-- Items Grid -->
    <div id="items-list" class="row g-4">
      <!-- Dynamic cards from dashboardscript.php will load here -->
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Load items dynamically
    fetch("phpfiles/get_approved_items.php")
      .then(response => response.text())
      .then(data => {
        document.getElementById("items-list").innerHTML = data;
      });
  </script>

  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <p>Are you sure you want to log out?</p>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="logout()">Log Out</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p id="loadingMessage" class="mt-3" style="font-size: 1.2rem;">Logging out...</p>
      </div>
    </div>
  </div>

  <!-- Logout Script -->
  <script>
    function showLoading(message = "Loading...") {
      const msgElem = document.getElementById("loadingMessage");
      if (msgElem) msgElem.textContent = message;
      const modal = new bootstrap.Modal(document.getElementById("loadingModal"));
      modal.show();
    }

    function logout() {
      // Hide the logout confirmation modal if open
      const logoutModal = bootstrap.Modal.getInstance(document.getElementById('logoutModal'));
      if (logoutModal) logoutModal.hide();

      // Show loading modal
      showLoading("Logging out...");

      // Simulate logout delay, then redirect
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);
    }
  </script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let editMode = false;
  let selectedIds = new Set();

  const editDeleteBtn = document.getElementById('editDeleteBtn');
  const itemsList = document.getElementById('items-list');

  if (!editDeleteBtn || !itemsList) {
    console.warn('Missing #editDeleteBtn or #items-list in DOM.');
    return;
  }

  // initial button label
  editDeleteBtn.textContent = 'Edit Items';

  // button click handler: enter edit mode OR perform delete
  editDeleteBtn.addEventListener('click', () => {
    if (!editMode) {
      enterEditMode();
    } else {
      handleDelete();
    }
  });

  // Enter edit mode: show checkboxes and reset selection
  function enterEditMode() {
    editMode = true;
    selectedIds.clear();
    updateButtonText();
    document.querySelectorAll('.card-custom').forEach(card => card.classList.add('edit-mode'));
    attachCheckboxHandlers(); // attach listeners to current checkboxes
  }

  // Exit edit mode: hide checkboxes and clear selections
  function exitEditMode() {
    editMode = false;
    selectedIds.clear();
    editDeleteBtn.textContent = 'Edit Items';
    document.querySelectorAll('.card-custom').forEach(card => {
      card.classList.remove('edit-mode');
      const cb = card.querySelector('.card-select');
      if (cb) cb.checked = false;
    });
  }

  // Delete flow
  function handleDelete() {
    if (selectedIds.size === 0) {
      // <-- this is the important part: show message and KEEP edit mode active
      alert('Please select at least one item to delete.');
      return; // do not exit edit mode
    }

    if (!confirm(`Delete ${selectedIds.size} item(s)?`)) return;

    const ids = Array.from(selectedIds);
    fetch('phpfiles/delete_items.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Items deleted successfully.');
        exitEditMode();
        loadItems();
      } else {
        alert('Error: ' + (data.error || 'Delete failed'));
      }
    })
    .catch(err => alert('Request failed: ' + err));
  }

  // Update selection from checkbox events
  function updateSelection(id, checked) {
    if (!id) return;
    if (checked) selectedIds.add(String(id));
    else selectedIds.delete(String(id));
    updateButtonText();
  }

  // Update button label to show number of selected items when in edit mode
  function updateButtonText() {
    if (!editMode) {
      editDeleteBtn.textContent = 'Edit Items';
      return;
    }
    const n = selectedIds.size;
    editDeleteBtn.textContent = n > 0 ? `Delete Items (${n})` : 'Delete Items';
  }

  // Attach change listeners to all .card-select checkboxes (replaces old listeners safely)
  function attachCheckboxHandlers() {
    document.querySelectorAll('.card-select').forEach(cb => {
      // replace with a fresh node to avoid duplicate handlers
      const newCb = cb.cloneNode(true);
      cb.parentNode.replaceChild(newCb, cb);

      // try to find an id for this checkbox:
      const id = getIdFromCheckbox(newCb);
      // initialize checked state if it was previously selected
      newCb.checked = selectedIds.has(String(id));

      newCb.addEventListener('change', (e) => {
        updateSelection(id, e.target.checked);
      });
    });
  }

  // Helper: try several places for an id (checkbox data-id, card data-id, value, id attribute)
  function getIdFromCheckbox(cb) {
    return cb.dataset.id
      || cb.getAttribute('data-id')
      || (cb.closest('.card-custom') && cb.closest('.card-custom').dataset.id)
      || cb.value
      || cb.id
      || null;
  }

  // Fetch and (re)render items, then re-attach checkbox handlers
  function loadItems() {
    fetch('phpfiles/get_approved_items.php')
      .then(res => res.text())
      .then(html => {
        itemsList.innerHTML = html;
        attachCheckboxHandlers();
        // keep edit-mode visuals if user was already in edit mode
        if (editMode) {
          document.querySelectorAll('.card-custom').forEach(card => card.classList.add('edit-mode'));
        }
      })
      .catch(err => console.error('Failed to load items:', err));
  }

  // Expose updateSelection globally only if your PHP uses inline onclick="updateSelection(...)".
  // If you prefer event listeners (recommended) you can omit this line.
  window.updateSelection = updateSelection;

  // initial load
  loadItems();
});
</script>


<!-- Search and Filter -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  let editMode = false;
  let selectedIds = new Set();

  const editDeleteBtn = document.getElementById('editDeleteBtn');
  const itemsList = document.getElementById('items-list');
  const searchInput = document.querySelector('input[placeholder="Search Lost Items"]');

  if (!editDeleteBtn || !itemsList) {
    console.warn('Missing #editDeleteBtn or #items-list in DOM.');
    return;
  }

  // initial button label
  editDeleteBtn.textContent = 'Edit Items';

  // button click handler: enter edit mode OR perform delete
  editDeleteBtn.addEventListener('click', () => {
    if (!editMode) {
      enterEditMode();
    } else {
      handleDelete();
    }
  });

  // Enter edit mode: show checkboxes and reset selection
  function enterEditMode() {
    editMode = true;
    selectedIds.clear();
    updateButtonText();
    document.querySelectorAll('.card-custom').forEach(card => card.classList.add('edit-mode'));
    attachCheckboxHandlers(); // attach listeners to current checkboxes
  }

  // Exit edit mode
  function exitEditMode() {
    editMode = false;
    selectedIds.clear();
    editDeleteBtn.textContent = 'Edit Items';
    document.querySelectorAll('.card-custom').forEach(card => {
      card.classList.remove('edit-mode');
      const cb = card.querySelector('.card-select');
      if (cb) cb.checked = false;
    });
  }

  // Delete flow
  function handleDelete() {
    if (selectedIds.size === 0) {
      alert('Please select at least one item to delete.');
      return;
    }
    if (!confirm(`Delete ${selectedIds.size} item(s)?`)) return;

    const ids = Array.from(selectedIds);
    fetch('phpfiles/delete_items.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Items deleted successfully.');
        exitEditMode();
        loadItems();
      } else {
        alert('Error: ' + (data.error || 'Delete failed'));
      }
    })
    .catch(err => alert('Request failed: ' + err));
  }

  // Update selection
  function updateSelection(id, checked) {
    if (!id) return;
    if (checked) selectedIds.add(String(id));
    else selectedIds.delete(String(id));
    updateButtonText();
  }

  function updateButtonText() {
    if (!editMode) {
      editDeleteBtn.textContent = 'Edit Items';
      return;
    }
    const n = selectedIds.size;
    editDeleteBtn.textContent = n > 0 ? `Delete Items (${n})` : 'Delete Items';
  }

  // Attach checkbox handlers
  function attachCheckboxHandlers() {
    document.querySelectorAll('.card-select').forEach(cb => {
      const newCb = cb.cloneNode(true);
      cb.parentNode.replaceChild(newCb, cb);
      const id = getIdFromCheckbox(newCb);
      newCb.checked = selectedIds.has(String(id));
      newCb.addEventListener('change', (e) => updateSelection(id, e.target.checked));
    });
  }

  function getIdFromCheckbox(cb) {
    return cb.dataset.id
      || cb.getAttribute('data-id')
      || (cb.closest('.card-custom') && cb.closest('.card-custom').dataset.id)
      || cb.value
      || cb.id
      || null;
  }

  // Load items dynamically
  function loadItems() {
    fetch('phpfiles/get_approved_items.php')
      .then(res => res.text())
      .then(html => {
        itemsList.innerHTML = html;
        attachCheckboxHandlers();
        if (editMode) {
          document.querySelectorAll('.card-custom').forEach(card => card.classList.add('edit-mode'));
        }
        applySearchFilter(); // re-apply filter after reload
      })
      .catch(err => console.error('Failed to load items:', err));
  }

  // Search filter
  function applySearchFilter() {
    const query = searchInput.value.trim().toLowerCase();
    document.querySelectorAll('#items-list .card-custom').forEach(card => {
      const titleElem = card.querySelector('.card-title'); // adjust if your title has different class
      const title = titleElem ? titleElem.textContent.toLowerCase() : '';
      card.style.display = title.includes(query) ? '' : 'none';
    });
  }

  if (searchInput) {
    searchInput.addEventListener('input', applySearchFilter);
  }

  window.updateSelection = updateSelection;

  // initial load
  loadItems();
});
</script>





</body>
</html>
